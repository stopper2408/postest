<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiter - Table View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Sticky Navigation with Glassmorphism -->
    <nav class="navbar">
        <div class="navbar-content">
            <h1 style="margin: 0;">Tables</h1>
            <a href="/login" style="text-decoration: none;">
                <button class="btn btn-secondary btn-sm">‚Üê Logout</button>
            </a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="table-grid" id="boxContainer">
            <!-- Tables will be dynamically inserted here -->
        </div>
    </div>
</body>
</html>


<script>
    const boxContainer = document.getElementById('boxContainer');
    function buttonYes(tableID) {
        fetch('checker/tables/' + tableID)
            .then(response => response.json())
            .then(data => {
                if (data.status == false) {
                    window.location.href = '/table_view/' + tableID;
                } else if (data.status == true) {
                    console.log("Opening table " + tableID + " has failed, this is because the table is already taken");
                } else {
                    console.log("There was an unexpected error when trying to open this table")
                }
            });
    }
    function buttonNo(tableID) {
        console.log("Cancelled opening table for table " + tableID);
        refreshTables(tableID);
    }
    function createTableBox(i) {
        const newBox = document.createElement('div');
        newBox.classList.add('table-card', 'stagger-item');
        newBox.id = i;
        newBox.classList.add('tableNumber' + i);
        newBox.innerHTML = `
            <div class="table-status"></div>
            <div class="table-number">Table ${i}</div>
            <div class="table-guests">Loading...</div>
        `;
        newBox.addEventListener('click', function () {
            if (newBox.classList.contains('not-available')) {
                newBox.classList.add('is-confirming-now');
                newBox.innerHTML = `
                    <div style="text-align: center;">
                        <h3>Open New Table?</h3>
                        <p style="color: #64748B; margin: 1rem 0;">Table ${i} is currently empty</p>
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button class="btn btn-success" onclick="buttonYes(${i})">Yes</button>
                            <button class="btn btn-secondary" onclick="buttonNo(${i})">No</button>
                        </div>
                    </div>
                `;
            } else if (newBox.classList.contains('available')) {
                window.location.href = '/table_view/' + i;
            } else {
                console.log("Error in table pop up");
            }
        });
        boxContainer.appendChild(newBox);
    }
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/checker/total_number_of_tables')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableCount = data.number_of_tables;
                    for (let i = 1; i <= tableCount; i++) {
                        createTableBox(i);
                    }
                    refreshTables(0); // this is the origional call of the function to input all the stuff in the tables
                } else {
                    console.log("Error with getting number of tables");
                }
            });
    });
    function refreshTables(tableID) { // 0 refreshes all tables, or specify a tableID to refresh only that one
        if (tableID === 0) {
            fetch('/checker/tables/')
                .then(response => response.json())
                .then(data => {
                    data.forEach(table => {
                        const boxToUpdate = document.querySelector('.tableNumber' + table.id);
                        if (boxToUpdate.classList.contains('is-confirming-now')) {
                            return; // This will prevent updating the table if the pop up window is open
                        }
                        
                        const statusDot = boxToUpdate.querySelector('.table-status') || document.createElement('div');
                        statusDot.className = 'table-status';
                        
                        if (table.status == false) {
                            boxToUpdate.innerHTML = `
                                <div class="table-status occupied"></div>
                                <div class="table-number">Table ${table.id}</div>
                                <div class="table-guests">${table.guests} guests</div>
                                <div class="badge badge-danger">Not Occupied</div>
                            `;
                            boxToUpdate.classList.add('not-available');
                            boxToUpdate.classList.remove('available');
                        } else if (table.status == true) { //false is when it is not occupied and true is when it is occupied
                            boxToUpdate.innerHTML = `
                                <div class="table-status available"></div>
                                <div class="table-number">Table ${table.id}</div>
                                <div class="table-guests">${table.guests} guests</div>
                                <div class="badge badge-success">Occupied</div>
                            `;
                            boxToUpdate.classList.add('available');
                            boxToUpdate.classList.remove('not-available');
                        }
                        else {
                            boxToUpdate.innerHTML = `
                                <div class="table-status pending"></div>
                                <div class="table-number">Table ${table.id}</div>
                                <div class="table-guests">Not Responding</div>
                            `;
                        }
                    });
                })
        }
        else if (tableID > 0) {
            const boxToUpdate = document.querySelector('.tableNumber' + tableID);
            fetch('/checker/tables/' + tableID)
                .then(response => response.json())
                .then(data => {
                    boxToUpdate.classList.remove('is-confirming-now');
                    if (data.status == false) {
                        boxToUpdate.innerHTML = `
                            <div class="table-status occupied"></div>
                            <div class="table-number">Table ${tableID}</div>
                            <div class="table-guests">${data.guests} guests</div>
                            <div class="badge badge-danger">Not Occupied</div>
                        `;
                        boxToUpdate.classList.add('not-available');
                        boxToUpdate.classList.remove('available');
                    } else if (data.status == true) { //false is when it is not occupied and true is when it is occupied
                        boxToUpdate.innerHTML = `
                            <div class="table-status available"></div>
                            <div class="table-number">Table ${tableID}</div>
                            <div class="table-guests">${data.guests} guests</div>
                            <div class="badge badge-success">Occupied</div>
                        `;
                        boxToUpdate.classList.add('available');
                        boxToUpdate.classList.remove('not-available');
                    }
                    else {
                        boxToUpdate.innerHTML = `
                            <div class="table-status pending"></div>
                            <div class="table-number">Table ${tableID}</div>
                            <div class="table-guests">Not Responding</div>
                        `;
                    }
                })
        }
    }
    function tableSetup() {
        console.log("tablesetup");
    }
    setInterval(function () {
        refreshTables(0);
    }, 10000);
</script>
</html>